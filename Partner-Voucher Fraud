SELECT
    -- Restaurant fields
    r.ID AS RESTAURANT_ID,
    o.RESTAURANT_NAME AS RESTAURANT_NAME,
    o.COUNTRY_NAME,
    YEAR(r.CREATED_AT) AS RX_Created_Year,
    -- Delivered orders count
    COUNT(DISTINCT CASE WHEN o.STATUS = 'DELIVERED' THEN o.ID END) AS Total_Orders,

    -- Total customers
    COUNT(DISTINCT c.ID) AS Total_Customers,

    -- New vs Old customers
    COUNT(DISTINCT CASE WHEN YEAR(c.CREATED_AT) = 2025 THEN c.ID END) AS New_CX_Count,
    COUNT(DISTINCT CASE WHEN YEAR(c.CREATED_AT) <> 2025 THEN c.ID END) AS Old_CX_Count,

    --New vs Old Percentage (New_CX_Count / Total_Customers)
    CASE 
        WHEN COUNT(DISTINCT c.ID) = 0 
            THEN NULL
        ELSE 
            (
                COUNT(DISTINCT CASE WHEN YEAR(c.CREATED_AT) = 2025 THEN c.ID END)
                /
                COUNT(DISTINCT c.ID)
            ) * 100
    END AS New_vs_Old_Percentage,

    -- Voucher vs Non-Voucher Orders
    COUNT(DISTINCT CASE WHEN pt.PROMOTION_APPLIED IS NOT NULL THEN pt.ORDER_ID END) AS Deliveroo_Voucher_Orders,
    COUNT(DISTINCT CASE WHEN pt.PROMOTION_APPLIED IS NULL THEN pt.ORDER_ID END) AS Non_Voucher_Orders,

    -- Financial metrics
    SUM(pt.PROMOTION_APPLIED) AS Deliveroo_Voucher,
    SUM(pt.TOTAL_INCL_TIP_AND_DONATIONS) AS Total_Amount,
    SUM(pt.AMOUNT_PAID) AS Paid_By_Card,
    SUM(o.MARKETER_DISCOUNT_VALUE - pt.CREDIT_APPLIED) AS User_Credits,
    SUM(pt.COMMISSION) AS Deliveroo_Commission,

    -- Voucher Percentage
    CASE 
        WHEN SUM(pt.TOTAL_INCL_TIP_AND_DONATIONS) = 0 THEN NULL
        ELSE (SUM(pt.PROMOTION_APPLIED) / SUM(pt.TOTAL_INCL_TIP_AND_DONATIONS)) * 100
    END AS Voucher_Percentage

FROM PRODUCTION.ORDERWEB.RESTAURANT_ACCOUNT r
JOIN production.denormalised.orders o
    ON r.ID = o.RESTAURANT_ID
JOIN production.denormalised.payment_transactions pt
    ON o.ID = pt.ORDER_ID
JOIN production.orderweb.users c
    ON c.ID = o.USER_ID

WHERE YEAR(r.CREATED_AT) = 2025
  AND o.COUNTRY_NAME IN (
            'UK','France','Italy','Belgium',
            'Ireland','Kuwait','United Arab Emirates'
          )
  AND o.ORDER_TYPE IN ('CUSTOMER_COLLECTION', 'RESTAURANT_FULFILLED')

GROUP BY
    r.ID,
    o.RESTAURANT_NAME,
    o.COUNTRY_NAME,
    r.CREATED_AT

HAVING
    -- Total orders > 0
    COUNT(DISTINCT CASE WHEN o.STATUS = 'DELIVERED' THEN o.ID END) > 0

    AND
    -- Voucher percentage > 50%
    SUM(pt.PROMOTION_APPLIED) > 0.5 * SUM(pt.TOTAL_INCL_TIP_AND_DONATIONS)

    AND
    -- New_CX_Count > 50% of Old_CX_Count 
    COUNT(DISTINCT CASE WHEN YEAR(c.CREATED_AT) = 2025 THEN c.ID END) 
        > 0.5 *
          COUNT(DISTINCT CASE WHEN YEAR(c.CREATED_AT) <> 2025 THEN c.ID END)
          ORDER BY TOTAL_ORDERS DESC;
