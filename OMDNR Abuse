WITH restaurants_2025 AS (
    SELECT
          r.ID AS restaurant_id
        , r.CREATED_AT AS px_creation_date
    FROM PRODUCTION.ORDERWEB.RESTAURANT_ACCOUNT AS r
    WHERE r.CREATED_AT >= DATE '2025-01-01'
      AND r.CREATED_AT <  DATEADD(day, 1, CURRENT_DATE())
),

orders_2025_delivered AS (
    SELECT
          o.RESTAURANT_ID
        , MIN(o.RESTAURANT_NAME)   AS RESTAURANT_NAME
        , MIN(o.RESTAURANT_TYPE)   AS RESTAURANT_TYPE
        , MIN(o.COUNTRY_NAME)      AS COUNTRY_NAME
        , COUNT(DISTINCT o.ID)     AS TOTAL_DELIVERED_ORDERS
    FROM PRODUCTION.DENORMALISED.ORDERS AS o
    WHERE o.STATUS = 'DELIVERED'
      AND o.COUNTRY_NAME IN (
            'UK','France','Italy','Belgium',
            'Ireland','Kuwait','United Arab Emirates'
          )
      AND o.ORDER_DATE >= DATE '2025-01-01'
      AND o.ORDER_DATE <  DATEADD(day, 1, CURRENT_DATE())
    GROUP BY
        o.RESTAURANT_ID
),

claims_omdnr_2025 AS (
    SELECT
          c.RESTAURANT_ID
        , COUNT(DISTINCT c.CLAIM_ID)          AS TOTAL_OMDNR_CLAIMS
        , COUNT(DISTINCT c.USER_ID)           AS TOTAL_USERS
        , COUNT(DISTINCT c.ORDER_ID)          AS TOTAL_OMDNR_ORDERS
        , SUM(c.CLAIM_AMOUNT_GBP)             AS TOTAL_CLAIMS_AMOUNT
        , SUM(c.COMPENSATED_AMOUNT_GBP)       AS TOTAL_COMPENSATED_AMOUNT
    FROM PRODUCTION.DENORMALISED.COMPENSATION_CLAIMS AS c
    WHERE c.ORDER_DATE >= DATE '2025-01-01'
      AND c.ORDER_DATE <  DATEADD(day, 1, CURRENT_DATE())
      AND c.CLAIM_REASON = 'Order Delivered Not Received'
    GROUP BY
        c.RESTAURANT_ID
)

SELECT
      o.RESTAURANT_ID
    , o.RESTAURANT_NAME
    , o.RESTAURANT_TYPE
    , o.COUNTRY_NAME
    , r.px_creation_date
    , o.TOTAL_DELIVERED_ORDERS
    , c.TOTAL_OMDNR_ORDERS
    , c.TOTAL_OMDNR_CLAIMS
    , (c.TOTAL_OMDNR_ORDERS * 100.0 / NULLIF(o.TOTAL_DELIVERED_ORDERS, 0)) AS OMDNR_PCT
    , c.TOTAL_USERS
    , c.TOTAL_CLAIMS_AMOUNT
    , c.TOTAL_COMPENSATED_AMOUNT

FROM restaurants_2025 r
JOIN orders_2025_delivered o
    ON o.RESTAURANT_ID = r.restaurant_id
JOIN claims_omdnr_2025 c
    ON c.RESTAURANT_ID = r.restaurant_id

WHERE
    o.TOTAL_DELIVERED_ORDERS >= 10          -- âœ… minimum volume filter
    AND
    (c.TOTAL_OMDNR_ORDERS * 100.0 / NULLIF(o.TOTAL_DELIVERED_ORDERS, 0)) >= 40

ORDER BY
    TOTAL_DELIVERED_ORDERS DESC;
